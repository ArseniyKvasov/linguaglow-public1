<div class="card p-2 m-2">
    <form method="post" action="{% url 'save_email_template' %}" class="mb-4">
        {% csrf_token %}
        <input type="hidden" name="template_id" id="template-id">

        <div class="mb-2">
            <label for="template-title" class="form-label">Заголовок</label>
            <input type="text" class="form-control" id="template-title" name="title" required>
        </div>

        <div class="mb-2">
            <label for="template-type" class="form-label">Тип письма</label>
            <select class="form-select" id="template-type" name="type" required>
                <!-- Скидки и акции -->
                <option value="discount_20">Скидка 20% на продление тарифа</option>
                <option value="discount_10">Скидка 10% на продление тарифа</option>
                <option value="gift_2000_tokens">2000 токенов в подарок</option>
                <option value="gift_1000_tokens">1000 токенов в подарок</option>
                <option value="discount_25_month">Скидка 25% на месяц</option>
                <option value="tokens_40_off">Токены со скидкой 40%</option>
                <option value="tokens_10_off">Токены со скидкой 10%</option>
                <option value="upgrade_25_off">Переход с бесплатного тарифа со скидкой 25%</option>

                <!-- Системные письма -->
                <option value="welcome">Приветственное сообщение</option>

                <!-- Напоминания о продлении без скидки -->
                <option value="reminder_renew_basic">Напоминание о продлении тарифа Базовый</option>
                <option value="reminder_renew_premium">Напоминание о продлении тарифа Премиум</option>
                <option value="reminder_renew_maximum">Напоминание о продлении тарифа Максимум</option>

                <!-- Покупка тарифов -->
                <option value="purchase_basic">Покупка тарифа Базовый</option>
                <option value="purchase_premium">Покупка тарифа Премиум</option>
                <option value="purchase_maximum">Покупка тарифа Максимум</option>

                <!-- Продление тарифов -->
                <option value="renew_basic">Продление тарифа Базовый</option>
                <option value="renew_premium">Продление тарифа Премиум</option>
                <option value="renew_maximum">Продление тарифа Максимум</option>

                <!-- Общее -->
                <option value="generic" selected>Обычное письмо</option>
                <option value="checklist_reminder">Напоминание о чек-листе</option>
                <option value="premium_reminder">Напоминание о наличии премиум</option>
            </select>
        </div>

        <div class="mb-2">
            <label for="template-html" class="form-label">HTML контент</label>
            <textarea class="form-control" id="template-html" name="html_content" rows="5" required></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Сохранить</button>
    </form>

    <h4>Готовые шаблоны:</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Тип</th>
                <th>Заголовок</th>
                <th>Обновлено</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for template in templates %}
            <tr>
                <td>{{ template.type }}</td>
                <td>{{ template.title }}</td>
                <td>{{ template.updated_at|date:"Y-m-d H:i" }}</td>
                <td>
                    <button class="btn btn-outline-success btn-sm" title="Использовать"
                            onclick="openEmailModal({{ template.id }}, `{{ template.html_content|escapejs }}`)">
                        <i class="bi bi-send"></i>
                    </button>
                    <button class="btn btn-outline-warning btn-sm" title="Редактировать" onclick="editTemplate({{ template.id }}, '{{ template.title|escapejs }}', `{{ template.html_content|escapejs }}`, '{{ template.type }}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" title="Удалить" onclick="deleteTemplate({{ template.id }})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="3">Нет шаблонов</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Модальное окно -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailModalLabel">Предпросмотр письма</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <div id="email-html-preview" class="border p-3 mb-3" style="background-color: #f8f9fa; max-height: 400px; overflow-y: auto;">
                    <!-- HTML содержимое письма появится здесь -->
                </div>

                <div class="mb-3">
                    <label class="form-label">Кому отправить:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="teacher" id="sendToTeachers">
                        <label class="form-check-label" for="sendToTeachers">Учителям</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="student" id="sendToStudents">
                        <label class="form-check-label" for="sendToStudents">Ученикам</label>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button id="sendTestBtn" class="btn btn-outline-primary" onclick="sendEmail(true)">Отправить тестово</button>
                    <button id="sendAllBtn" class="btn btn-primary" onclick="sendEmail(false)">Отправить всем</button>
                </div>

                <div id="sendStatus" class="mt-3 text-success fw-bold d-none"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function editTemplate(id, title, html) {
        document.getElementById('template-id').value = id;
        document.getElementById('template-title').value = title;
        document.getElementById('template-html').value = html;
        document.getElementById('template-type').value = type;
    }

    function deleteTemplate(id) {
        if (!confirm("Удалить шаблон?")) return;

        fetch("{% url 'delete_email_template' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `template_id=${id}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
</script>

<script>
    let currentTemplateId = null;

    function openEmailModal(templateId, html) {
        currentTemplateId = templateId;
        document.getElementById('email-html-preview').innerHTML = html;
        document.getElementById('sendStatus').classList.add('d-none');
        document.getElementById('sendStatus').innerText = '';
        document.getElementById('sendTestBtn').disabled = false;
        document.getElementById('sendAllBtn').disabled = false;

        const modal = new bootstrap.Modal(document.getElementById('emailModal'));
        modal.show();
    }

    function sendEmail(isTest) {
        const sendToTeachers = document.getElementById('sendToTeachers').checked;
        const sendToStudents = document.getElementById('sendToStudents').checked;

        if (!isTest && !sendToTeachers && !sendToStudents) {
            alert("Выберите хотя бы одну роль получателей.");
            return;
        }

        const button = isTest ? document.getElementById('sendTestBtn') : document.getElementById('sendAllBtn');
        button.disabled = true;

        fetch("{% url 'send_email_template' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                template_id: currentTemplateId,
                test: isTest,
                roles: isTest ? [] : [
                    ...(sendToTeachers ? ['teacher'] : []),
                    ...(sendToStudents ? ['student'] : [])
                ]
            })
        })
        .then(response => response.json())
        .then(data => {
            const status = document.getElementById('sendStatus');
            status.classList.remove('d-none', 'text-danger');

            if (data.success) {
                if (data.count === 'pending') {
                    status.innerText = 'Рассылка запущена. Ожидайте завершения...';

                    if (data.task_id) {
                        const checkStatus = () => {
                            fetch(`/users/api/email-task-status/${data.task_id}/`)
                                .then(res => res.json())
                                .then(res => {
                                    if (res.status === 'SUCCESS') {
                                        status.innerText = `Рассылка завершена: ${res.result.count} писем. Роли: ${res.result.roles.join(', ')}`;
                                    } else if (res.status === 'FAILURE') {
                                        status.classList.add('text-danger');
                                        status.innerText = 'Ошибка при выполнении задачи.';
                                    } else {
                                        setTimeout(checkStatus, 2000);
                                    }
                                })
                                .catch(() => {
                                    status.classList.add('text-danger');
                                    status.innerText = 'Ошибка при проверке статуса задачи.';
                                });
                        };
                        setTimeout(checkStatus, 2000);
                    }
                } else {
                    status.innerText = `Тестовое письмо отправлено.`;
                }
            } else {
                status.classList.add('text-danger');
                status.innerText = "Ошибка при отправке.";
            }
        })
        .catch(error => {
            const status = document.getElementById('sendStatus');
            status.classList.remove('d-none');
            status.classList.add('text-danger');
            status.innerText = "Произошла ошибка при выполнении запроса.";
        });
    }
</script>