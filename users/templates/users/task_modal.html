{% load custom_filters %}

<!-- –ü–µ—Ä–µ–¥–∞—ë–º task_status –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ JS –±–µ–∑–æ–ø–∞—Å–Ω–æ -->
{{ task_status|json_script:"task-status-data" }}

<!-- ===========================
     –ú–û–î–ê–õ–ö–ò (Guide + Steps + Create)
     =========================== -->

<!-- {% if gender == "–ñ–µ–Ω—Å–∫–∏–π" %}-- >
<!-- –ú–æ–¥–∞–ª–∫–∞: –ì–∏–¥ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ -->
<div class="modal fade" id="guideModal" tabindex="-1" aria-labelledby="guideLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="guideLabel">–ì–∏–¥ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ LinguaGlow</h5>
            </div>
            <div class="modal-body">
                <p><strong>–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! üöÄ</strong> –ü–µ—Ä–≤—ã–π —à–∞–≥ –ø—Ä–æ–π–¥–µ–Ω ‚Äî —Ç—ã —Å–æ–∑–¥–∞–ª–∞ –∞–∫–∫–∞—É–Ω—Ç.</p>
                <p>–ù–∏–∂–µ ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π –∏ –ø—Ä–∏—è—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ —Ç–æ–º—É, –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Å—ë –∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫ –≤ –∫–æ–Ω—Ü–µ. –ì–æ—Ç–æ–≤–∞? –ü–æ–µ—Ö–∞–ª–∏! üéÅ</p>
                <hr>
                <h6>–ß—Ç–æ –¥–∞–ª—å—à–µ?</h6>
                <p>–ú—ã –±—É–¥–µ–º –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –æ—Å–≤–æ–∏—Ç—å—Å—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="guideNextBtn">
                    –î–∞–ª—å—à–µ ‚Üí
                </button>
            </div>
        </div>
    </div>
</div>


<!-- –ú–æ–¥–∞–ª–∫–∞: –®–∞–≥ 1 –∏–∑ 5 ‚Äî –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å -->
<div class="modal fade" id="step1Modal" tabindex="-1" aria-labelledby="step1Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="step1Label">–®–∞–≥ 1 –∏–∑ 3 ‚Äî –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h5>
            </div>
            <div class="modal-body">
                <p><strong>–¢—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∞—Å—å –∏ –ø–æ–ø–∞–ª–∞ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.</strong></p>
                <p>–ó–¥–µ—Å—å —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ —Ç–≤–æ–∏ –∫—É—Ä—Å—ã, –∫–ª–∞—Å—Å—ã –∏ –ø—Ä–æ–µ–∫—Ç—ã.</p>
                <hr>
                <p>–ì–æ—Ç–æ–≤–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –ø–æ–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–≤–æ–π –ø–µ—Ä–≤—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="step1NextBtn">
                    –î–∞–ª—å—à–µ ‚Üí
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ -->
<div class="modal fade" id="taskCreateClassroomCompletedModal" tabindex="-1" aria-labelledby="taskCompletedLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskCompletedLabel">–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! üî•</h5>
            </div>
            <div class="modal-body">
                <p>–¢—ã —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∞ –æ–¥–∏–Ω –∏–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö —É—Ä–æ–∫–æ–≤.</p>
                <p>–û—Ç–ª–∏—á–Ω–æ ‚Äî –Ω–æ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ.</p>
            </div>
            <div class="modal-footer">
                <a href="{% url 'home' %}" class="btn btn-primary">
                    –ß—Ç–æ –¥–∞–ª—å—à–µ?
                </a>
            </div>
        </div>
    </div>
</div>


<!-- –ú–æ–¥–∞–ª–∫–∞: –ü—Ä–∏–≥–ª–∞—Å–∏ –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ (–ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –ø–æ–ª—É—á–µ–Ω) -->
<div class="modal fade" id="studentInviteModal" tabindex="-1" aria-labelledby="studentInviteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentInviteLabel">–ü—Ä–∏–≥–ª–∞—Å–∏ –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞</h5>
            </div>
            <div class="modal-body">
                <p><strong>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ –¢–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ —É —Ç–µ–±—è.</strong></p>
                <p>–¢–µ–ø–µ—Ä—å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ ‚Äî –ø—Ä–∏–≥–ª–∞—Å–∏ –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –∏ –Ω–∞—á–Ω–∏ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –∑–∞–Ω—è—Ç–∏—è. –¢—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π üöÄ</p>

                <!-- –ë–ª–æ–∫ —Å —Å—Å—ã–ª–∫–æ–π –∏ –∫–Ω–æ–ø–∫–∞–º–∏ -->
                <div class="mt-4">
                    <label for="inviteLink" class="form-label">–°—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
                    <div class="input-group mb-2">
                        <input
                            id="inviteLink"
                            class="form-control"
                            type="text"
                            readonly
                            value="{{ classroom_link|default:'' }}"
                            aria-label="–°—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è"
                        />
                        <button class="btn btn-outline-secondary" type="button" id="copyInviteBtn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
                            <i class="bi bi-clipboard"></i>&nbsp;–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>

                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-primary" id="shareInviteBtn" type="button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π —à—ç—Ä">
                            <i class="bi bi-share-fill"></i>&nbsp;–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>

                        <div id="inviteStatus" class="ms-3 text-muted" aria-live="polite"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="step5NextBtn" data-bs-dismiss="modal" onclick="updateTaskStatus('student_invitation', 'student_invitation_use');">
                    –ì–æ—Ç–æ–≤–æ
                </button>
            </div>
        </div>
    </div>
</div>



<!--{% elif gender == "–ú—É–∂—Å–∫–æ–π" %}-->


<div class="modal fade" id="guideModal" tabindex="-1" aria-labelledby="guideLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="guideLabel">–ì–∏–¥ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ LinguaGlow</h5>
            </div>
            <div class="modal-body">
                <p><strong>–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! üöÄ</strong> –ü–µ—Ä–≤—ã–π —à–∞–≥ –ø—Ä–æ–π–¥–µ–Ω ‚Äî —Ç—ã —Å–æ–∑–¥–∞–ª –∞–∫–∫–∞—É–Ω—Ç.</p>
                <p>–ù–∏–∂–µ ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π –∏ –ø—Ä–∏—è—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ —Ç–æ–º—É, –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Å—ë –∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫ –≤ –∫–æ–Ω—Ü–µ. –ì–æ—Ç–æ–≤? –ü–æ–µ—Ö–∞–ª–∏! üéÅ</p>
                <hr>
                <h6>–ß—Ç–æ –¥–∞–ª—å—à–µ?</h6>
                <p>–ú—ã –±—É–¥–µ–º –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –æ—Å–≤–æ–∏—Ç—å—Å—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="guideNextBtn">
                    –î–∞–ª—å—à–µ ‚Üí
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –®–∞–≥ 1 –∏–∑ 5 ‚Äî –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å -->
<div class="modal fade" id="step1Modal" tabindex="-1" aria-labelledby="step1Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="step1Label">–®–∞–≥ 1 –∏–∑ 3 ‚Äî –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h5>
            </div>
            <div class="modal-body">
                <p><strong>–¢—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –∏ –ø–æ–ø–∞–ª –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.</strong></p>
                <p>–ó–¥–µ—Å—å —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ —Ç–≤–æ–∏ –∫—É—Ä—Å—ã, –∫–ª–∞—Å—Å—ã –∏ –ø—Ä–æ–µ–∫—Ç—ã.</p>
                <hr>
                <p>–ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –ø–æ–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–≤–æ–π –ø–µ—Ä–≤—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="step1NextBtn">
                    –î–∞–ª—å—à–µ ‚Üí
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ -->
<div class="modal fade" id="taskCreateClassroomCompletedModal" tabindex="-1" aria-labelledby="taskCompletedLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskCompletedLabel">–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! üî•</h5>
            </div>
            <div class="modal-body">
                <p>–¢—ã —É–∂–µ –¥–æ–±–∞–≤–∏–ª –æ–¥–∏–Ω –∏–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö —É—Ä–æ–∫–æ–≤.</p>
                <p>–û—Ç–ª–∏—á–Ω–æ ‚Äî –Ω–æ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ.</p>
            </div>
            <div class="modal-footer">
                <a href="{% url 'home' %}" class="btn btn-primary">
                    –ß—Ç–æ –¥–∞–ª—å—à–µ?
                </a>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –ü—Ä–∏–≥–ª–∞—Å–∏ –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ (–ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –ø–æ–ª—É—á–µ–Ω) -->
<div class="modal fade" id="studentInviteModal" tabindex="-1" aria-labelledby="studentInviteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentInviteLabel">–ü—Ä–∏–≥–ª–∞—Å–∏ –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞</h5>
            </div>
            <div class="modal-body">
                <p><strong>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ –¢–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ —É —Ç–µ–±—è.</strong></p>
                <p>–¢–µ–ø–µ—Ä—å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ ‚Äî –ø—Ä–∏–≥–ª–∞—Å–∏ –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –∏ –Ω–∞—á–Ω–∏ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –∑–∞–Ω—è—Ç–∏—è. –¢—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π üöÄ</p>

                <!-- –ë–ª–æ–∫ —Å —Å—Å—ã–ª–∫–æ–π –∏ –∫–Ω–æ–ø–∫–∞–º–∏ -->
                <div class="mt-4">
                    <label for="inviteLink" class="form-label">–°—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
                    <div class="input-group mb-2">
                        <input
                            id="inviteLink"
                            class="form-control"
                            type="text"
                            readonly
                            value="{{ classroom_link|default:'' }}"
                            aria-label="–°—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è"
                        />
                        <button class="btn btn-outline-secondary" type="button" id="copyInviteBtn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
                            <i class="bi bi-clipboard"></i>&nbsp;–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>

                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-primary" id="shareInviteBtn" type="button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π —à—ç—Ä">
                            <i class="bi bi-share-fill"></i>&nbsp;–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>

                        <div id="inviteStatus" class="ms-3 text-muted" aria-live="polite"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="stepInviteBtn" data-bs-dismiss="modal" onclick="updateTaskStatus('student_invitation', 'student_invitation_use');">
                    –ì–æ—Ç–æ–≤–æ
                </button>
            </div>
        </div>
    </div>
</div>




<!--{% endif %}-->

<!-- –ú–æ–¥–∞–ª–∫–∞: –®–∞–≥ 2 ‚Äî –°–æ–∑–¥–∞–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å -->
<div class="modal fade" id="step2Modal" tabindex="-1" aria-labelledby="step2Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="step2Label">–®–∞–≥ 2 –∏–∑ 3 ‚Äî –°–æ–∑–¥–∞–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å</h5>
            </div>
            <div class="modal-body">
                <p><strong>–ü–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å.</strong></p>
                <p>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å!" –∏ —Å–ª–µ–¥—É–π –ø–æ–¥—Å–∫–∞–∑–∫–∞–º, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å.</p>
            </div>
            <div class="modal-footer">
                <button type="button" id="startClassBtn" class="btn btn-success">
                    –ù–∞—á–∞—Ç—å!
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ–∑–¥–∞–Ω –ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏
    async function completeCreateClassroom() {
        try {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ (–®–∞–≥ 3 ‚Äî –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è)
            showModal('taskCreateClassroomCompletedModal');
        } catch (err) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å create_classroom', err);
        }
    }

    function setCookie(name, value, minutes) {
        const d = new Date();
        d.setTime(d.getTime() + minutes * 60 * 1000);
        document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º mode
    const infoStatusContainer = document.getElementById("infoStatusContainer");
    if (infoStatusContainer) {
        const statusMode = infoStatusContainer.dataset.mode;
        if (statusMode === "classroom" || statusMode === "generation") {
            if (statusMode === "classroom" && currentStatus['create_classroom'] !== "–í—ã–ø–æ–ª–Ω–µ–Ω–æ") {
                updateTaskStatus('create_classroom', 'task_generated');
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ª–æ–∫–∞–ª—å–Ω–æ
                currentStatus['create_classroom'] = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                currentStatus['task_generated'] = '–í –ø—Ä–æ–≥—Ä–µ—Å—Å–µ';
                setTimeout(completeCreateClassroom, 15000);
            }
        } else if (statusMode === "home") {
            let redirected = false;

            // Classroom redirect
            if (!getCookie('autoOpenClassroom')) {
                const classroomCard = document.querySelector('.classroom-card');
                if (classroomCard && currentStatus['create_classroom'] !== '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' && currentStatus['registration'] === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ') {
                    const classroomRole = classroomCard.querySelector('.badge-role');
                    if (classroomRole) {
                        if (classroomRole === "–£—á–∏—Ç–µ–ª—å") {
                            const linkClassroom = classroomCard.querySelector('.stretched-link');
                            if (linkClassroom) {
                                window.location.href = linkClassroom.href;
                                setCookie('autoOpenClassroom', '1', 20);
                                redirected = true;
                            }
                        }
                    }
                }
            }

            // Course redirect
            if (!redirected && !getCookie('autoOpenCourse')) {
                const courseCard = document.querySelector('.course-card');
                if (courseCard && currentStatus['task_generated'] !== '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' && currentStatus['create_classroom'] === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ') {
                    const linkCourse = courseCard.querySelector('.stretched-link');
                    if (linkCourse) {
                        window.location.href = linkCourse.href;
                        setCookie('autoOpenCourse', '1', 20);
                        redirected = true;
                    }
                }
            }

            // –ú–æ–¥–∞–ª–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞
            if (!redirected) {
                openRelevantModal();
            }
        } else if (statusMode && currentStatus['gift_received'] == "–í –ø—Ä–æ–≥—Ä–µ—Å—Å–µ") {
            openRelevantModal();
        }
    }
});
</script>

<!-- –ú–æ–¥–∞–ª–∫–∞: –®–∞–≥ 3 ‚Äî –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å -->
<div class="modal fade" id="step3Modal" tabindex="-1" aria-labelledby="step3Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="step3Label">–®–∞–≥ 3 –∏–∑ 5 ‚Äî –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å</h5>
            </div>
            <div class="modal-body">
                <p><strong>–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ò–ò –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å—Å—è –ø–æ–¥ —Ç–≤–æ–π —Å—Ç–∏–ª—å.</strong></p>
            </div>
            <div class="modal-footer">
                <a href="{% url 'ai_profile_survey' %}" type="button" class="btn btn-primary" id="step3NextBtn">
                    –ü–µ—Ä–µ–π—Ç–∏
                </a>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –®–∞–≥ 4 ‚Äî –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫ -->
<div class="modal fade" id="step4Modal" tabindex="-1" aria-labelledby="step4Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="step4Label">–®–∞–≥ 3 –∏–∑ 3 ‚Äî –°–æ–∑–¥–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —É—Ä–æ–∫</h5>
            </div>
            <div class="modal-body">
                <p><strong>–¢—ã –ø–æ—á—Ç–∏ —É —Ü–µ–ª–∏! üéØ</strong></p>
                <p>–î–∞–≤–∞–π —Å–æ–∑–¥–∞–¥–∏–º –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫.  </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="createCourseBtn">
                    Let's go!
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è -->
<div class="modal fade" id="addTaskGuideModal" tabindex="-1" aria-labelledby="addTaskGuideLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow rounded">
            <div class="modal-header">
                <h5 class="modal-title" id="addTaskGuideLabel">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è ‚ú®</h5>
            </div>
            <div class="modal-body">
                <p>–ù–∞–∂–º–∏ <strong>¬´–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ¬ª</strong> –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="scrollToAddTask()">
                    –ü–æ–Ω—è—Ç–Ω–æ!
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ 2: –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
<div class="modal fade" id="taskCreatedModal" tabindex="-1" aria-labelledby="taskCreatedLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow rounded">
            <div class="modal-header">
                <h5 class="modal-title" id="taskCreatedLabel">–ö–ª–∞—Å—Å–Ω–æ! üòå</h5>
            </div>
            <div class="modal-body">
                <p>–ü–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ.</p>
                <p>–ê —Ç–µ–ø–µ—Ä—å ‚Äî –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Ä–∞–∑–¥–µ–ª –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å –≤ 2 –∫–ª–∏–∫–∞: –Ω–∞–∂–º–∏ <strong>¬´+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª¬ª</strong>.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="scrollToAddSection()">
                    –û–∫!
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ 3: –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ -->
<div class="modal fade" id="congratsModal" tabindex="-1" aria-labelledby="congratsLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow rounded">
            <div class="modal-header">
                <h5 class="modal-title" id="congratsLabel">–£—Ä–∞! üéâ</h5>
            </div>
            <div class="modal-body">
                <p>–¢–µ–ø–µ—Ä—å —Ç—ã –∑–Ω–∞–µ—à—å, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ò–ò –≤ —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç–µ.</p>
                <p>–ü–æ–π–¥—ë–º –¥–∞–ª—å—à–µ?</p>
            </div>
            <div class="modal-footer">
                <a href="{% url 'home' %}" class="btn btn-primary">–î–ê!</a>
            </div>
        </div>
    </div>
</div>

<script>
   function scrollToAddTask() {
        const el = document.getElementById("add-task-button-wrapper");
        if (el) {
            el.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }

   function scrollToAddSection() {
        const el = document.querySelector(".add-section-link");
        if (el) {
            el.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }


    document.addEventListener('DOMContentLoaded', function () {
        const inviteInput = document.getElementById('waitingInviteLink');
        const copyBtn = document.getElementById('waitingCopyBtn');
        const spinner = document.getElementById('waitingSpinner');
        const statusText = document.getElementById('waitingStatusText');
        const waitingModalEl = document.getElementById('waitingStudentModal');

        function getInviteUrl() {
            return inviteInput ? (inviteInput.value || '').trim() : '';
        }

        function copyToClipboard(text) {
            if (!text) return Promise.reject(new Error('–ü—É—Å—Ç–∞—è —Å—Å—ã–ª–∫–∞'));
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
            }
            return new Promise((resolve, reject) => {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    resolve();
                } catch (err) {
                    reject(err);
                }
            });
        }

        if (copyBtn) {
            copyBtn.addEventListener('click', function () {
                const url = getInviteUrl();
                if (!url) {
                    statusText.textContent = '–°—Å—ã–ª–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                    statusText.classList.add('text-danger');
                    setTimeout(() => {
                        statusText.classList.remove('text-danger');
                        statusText.textContent = '–û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ —É—á–µ–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—Å—è...';
                    }, 3000);
                    return;
                }

                copyBtn.disabled = true;
                copyToClipboard(url)
                    .then(() => {
                        statusText.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞';
                        statusText.classList.add('text-success');
                    })
                    .catch(() => {
                        statusText.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                        statusText.classList.add('text-danger');
                    })
                    .finally(() => {
                        setTimeout(() => {
                            statusText.classList.remove('text-success', 'text-danger');
                            statusText.textContent = '–û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ —É—á–µ–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—Å—è...';
                            copyBtn.disabled = false;
                        }, 2500);
                    });
            });
        }

        // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ ‚Äî –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–∫–ª—é—á–∏–º –∫–Ω–æ–ø–∫—É
        if (waitingModalEl) {
            waitingModalEl.addEventListener('show.bs.modal', function () {
                const url = getInviteUrl();
                if (!url) {
                    if (spinner) spinner.classList.add('d-none');
                    if (statusText) {
                        statusText.textContent = '–°—Å—ã–ª–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞';
                        statusText.classList.add('text-muted');
                    }
                    if (copyBtn) copyBtn.disabled = true;
                } else {
                    if (spinner) spinner.classList.remove('d-none');
                    if (statusText) {
                        statusText.textContent = '–û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ —É—á–µ–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—Å—è...';
                        statusText.classList.remove('text-muted');
                    }
                    if (copyBtn) copyBtn.disabled = false;
                }
            });

            // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            waitingModalEl.addEventListener('hidden.bs.modal', function () {
                if (spinner) spinner.classList.remove('d-none');
                if (statusText) {
                    statusText.textContent = '–û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ —É—á–µ–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—Å—è...';
                    statusText.classList.remove('text-success', 'text-danger', 'text-muted');
                }
                if (copyBtn) copyBtn.disabled = false;
            });
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const inviteLinkInput = document.getElementById('inviteLink');
        const copyBtn = document.getElementById('copyInviteBtn');
        const shareBtn = document.getElementById('shareInviteBtn');
        const statusEl = document.getElementById('inviteStatus');
        const step5NextBtn = document.getElementById('stepInviteBtn');
        const step5ModalEl = document.getElementById('step5Modal');

        // safety: —Å—Å—ã–ª–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π
        function getInviteUrl() {
            return inviteLinkInput ? (inviteLinkInput.value || '').trim() : '';
        }

        // –¢–∞–π–º–µ—Ä –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        let activationTimeout = null;

        // –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ main button —á–µ—Ä–µ–∑ 5 —Å–µ–∫
        function scheduleActivateMainButton() {
            if (activationTimeout) {
                clearTimeout(activationTimeout);
                activationTimeout = null;
            }

            // –ó–∞–±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–æ—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è
            activationTimeout = setTimeout(() => {
                if (step5NextBtn) {
                    step5NextBtn.disabled = false;
                    step5NextBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω';
                }
                if (statusEl) statusEl.textContent = '–ì–æ—Ç–æ–≤–æ';
                if (copyBtn) copyBtn.disabled = false;
                if (shareBtn) shareBtn.disabled = false;
                activationTimeout = null;
            }, 5000);
        }

        // Copy handler
        function copyToClipboard(text) {
            if (!text) return Promise.reject(new Error('–ü—É—Å—Ç–∞—è —Å—Å—ã–ª–∫–∞'));
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
            }
            return new Promise((resolve, reject) => {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    resolve();
                } catch (err) {
                    reject(err);
                }
            });
        }

        // Share —á–µ—Ä–µ–∑ Web Share API ‚Äî –∏–Ω–∞—á–µ –Ω–∏—á–µ–≥–æ (–Ω–µ –¥–µ–ª–∞–µ–º fallback)
        function shareViaNavigator(text, url) {
            if (!navigator.share) {
                // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏–ª: "–∏–Ω–∞—á–µ –Ω–∏—á–µ–≥–æ" ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback'—ã
                return Promise.reject(new Error('no-web-share'));
            }
            return navigator.share({
                title: '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∫–ª–∞—Å—Å',
                text: text,
                url: url || undefined
            });
        }

        // –°–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ç–µ–∫—Å—Ç —Å —Å—Å—ã–ª–∫–æ–π
        function buildShareText(url) {
            return '–ü—Ä–∏–≤–µ—Ç! –ü—Ä–µ–¥–ª–∞–≥–∞—é –ø—Ä–æ–≤–µ—Å—Ç–∏ —Å–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ. –°–æ–∑–¥–∞–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–∫–∫–∞—É–Ω—Ç –∑–∞—Ä–∞–Ω–µ–µ. –í–æ—Ç —Å—Å—ã–ª–∫–∞: ' + url;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        if (copyBtn) {
            copyBtn.addEventListener('click', function () {
                const inviteUrl = getInviteUrl();
                if (!inviteUrl) {
                    statusEl.textContent = '–°—Å—ã–ª–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                    return;
                }
                copyToClipboard(inviteUrl)
                    .then(() => {
                        statusEl.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
                        scheduleActivateMainButton();
                    })
                    .catch(() => {
                        statusEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                    });
            });
        }

        if (shareBtn) {
            shareBtn.addEventListener('click', function () {
                const inviteUrl = getInviteUrl();
                if (!inviteUrl) {
                    statusEl.textContent = '–°—Å—ã–ª–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                    return;
                }
                const message = buildShareText(inviteUrl);
                shareViaNavigator(message, inviteUrl)
                    .then(() => {
                        statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                        scheduleActivateMainButton();
                    })
                    .catch((err) => {
                        // –ï—Å–ª–∏ Web Share –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º (–ø–æ –∂–µ–ª–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)
                        if (err && err.message === 'no-web-share') {
                            statusEl.textContent = '–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                            // –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º fallback
                        } else {
                            // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –æ—Ç–º–µ–Ω–∏—Ç—å –æ–∫–Ω–æ —à–∞—Ä–∏–Ω–≥–∞ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –∫–∞–∫ –¥–µ–π—Å—Ç–≤–∏–µ
                            statusEl.textContent = '–û—Ç–º–µ–Ω–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
                            scheduleActivateMainButton();
                        }
                    });
            });
        }

        // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
        if (!getInviteUrl()) {
            if (copyBtn) copyBtn.disabled = true;
            if (shareBtn) shareBtn.disabled = true;
            if (statusEl) statusEl.textContent = '–°—Å—ã–ª–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞';
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
        if (step5ModalEl) {
            step5ModalEl.addEventListener('hidden.bs.modal', function () {
                if (activationTimeout) {
                    clearTimeout(activationTimeout);
                    activationTimeout = null;
                }
                if (statusEl) statusEl.textContent = '';
                // —Å–±—Ä–æ—Å–∏–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
                if (step5NextBtn) {
                    step5NextBtn.disabled = true;
                    step5NextBtn.textContent = '–°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞';
                }
            });
        }
    });
</script>

<!-- –ú–æ–¥–∞–ª–∫–∞: –û–∂–∏–¥–∞–µ–º —É—á–µ–Ω–∏–∫–∞ -->
<div class="modal fade" id="waitingStudentModal" tabindex="-1" aria-labelledby="waitingStudentLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content shadow-lg rounded-3 border-0">

            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-semibold" id="waitingStudentLabel">
                    –û—Å—Ç–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è —É—á–µ–Ω–∏–∫–∞
                </h5>
            </div>

            <!-- –¢–µ–ª–æ -->
            <div class="modal-body">
                <p class="mb-3">
                    –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ —Ç–≤–æ–π e-mail:
                    <strong>{{ user.email|default:"(email –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)" }}</strong>.
                </p>
                <p class="mb-3">
                    –ß—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å, –º–æ–∂–µ—à—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫—É –ª—é–±—ã–º —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.
                </p>

                <!-- –°—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
                <label for="waitingInviteLink" class="form-label small text-muted">–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
                <div class="input-group mb-3">
                    <input
                        id="waitingInviteLink"
                        class="form-control"
                        type="text"
                        readonly
                        value="{{ classroom_link|default:'' }}"
                        aria-label="–°—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è"
                    />
                    <button class="btn btn-outline-primary" type="button" id="waitingCopyBtn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
                        <i class="bi bi-clipboard"></i>&nbsp;–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å -->
                <div class="d-flex align-items-center gap-2 mt-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
                    <div id="waitingStatusText" class="fw-medium">
                        –ñ–¥—ë–º, –ø–æ–∫–∞ —É—á–µ–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—Å—è...
                    </div>
                </div>

                <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
                <div id="waitingHint" class="mt-3 text-muted small">
                    ‚úâÔ∏è –ï—Å–ª–∏ –ø–∏—Å—å–º–∞ –Ω–µ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø–∞–ø–∫—É ¬´–°–ø–∞–º/–ü—Ä–æ–º–æ–∞–∫—Ü–∏–∏¬ª –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é.
                </div>
            </div>

            <!-- –§—É—Ç–µ—Ä -->
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary btn-sm" id="waitingCloseBtn" data-bs-dismiss="modal">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>


<!-- –ú–æ–¥–∞–ª–∫–∞ 1: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî —á–µ–∫–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω -->
<div class="modal fade" id="receiveGift" tabindex="-1" aria-labelledby="receiveGiftLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiveGiftLabel">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî —á–µ–∫–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω</h5>
            </div>

            <div class="modal-body text-center">
                <h2 class="mb-3">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ</h2>
                <p class="lead mb-3">–¢—ã –≤—ã–ø–æ–ª–Ω–∏–ª –≤—Å–µ —à–∞–≥–∏ —á–µ–∫–ª–∏—Å—Ç–∞ ‚Äî –¥–µ—Ä–∂–∏ —Å–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫!</p>
            </div>

            <div class="modal-footer justify-content-center">
                <button type="button"
                        class="btn btn-primary btn-lg"
                        id="getGiftBtn"
                        data-bs-dismiss="modal"
                        data-bs-toggle="modal"
                        data-bs-target="#giftModal" onclick="updateTaskStatus('gift_received', 'student_invitation');">
                    –ü–æ–ª—É—á–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ 2: –¢–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ -->
<div class="modal fade" id="giftModal" tabindex="-1" aria-labelledby="giftLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="giftLabel">–¢–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫</h5>
            </div>

            <div class="modal-body">
                <div class="d-flex gap-3 align-items-start">
                    <div class="display-1">üéÅ</div>
                    <div>
                        <h4 class="mb-2">–¢–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ ‚Äî {% if present_type == "–¢–æ–∫–µ–Ω—ã" %}500 —Ç–æ–∫–µ–Ω–æ–≤!{% else %}<span class="text-success">–ü—Ä–µ–º–∏—É–º-–¥–æ—Å—Ç—É–ø –Ω–∞ –Ω–µ–¥–µ–ª—é</span>{% endif %}</h4>
                        <p class="mb-2">
                            –ü—Ä–∏–≥–ª–∞—à–∞–π —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ —É—á–µ–Ω–∏–∫–æ–≤ –∏ —Å–æ–∑–¥–∞–≤–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —É—Ä–æ–∫–∏ –≤ 2 –∫–ª–∏–∫–∞ ‚Äî –±–æ–ª—å—à–µ –Ω–∏–∫–∞–∫–æ–π —Ä—É—Ç–∏–Ω—ã!
                        </p>
                        <p class="text-muted small mb-0">–ü–æ–¥–∞—Ä–æ–∫ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
                    </div>
                </div>
            </div>

            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success btn-lg" onclick="updateTaskStatus('gift_received', 'student_invitation'); window.location.reload();">
                    –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const studentEl = document.getElementById('studentJoinedModal');
        const giftEl = document.getElementById('giftModal');

        const getGiftBtn = document.getElementById('getGiftBtn');
        const activateGiftBtn = document.getElementById('activateGiftBtn');

        const joinedCopyBtn = document.getElementById('joinedCopyBtn');
        const giftCopyBtn = document.getElementById('giftCopyBtn');

        const joinedInviteInput = document.getElementById('joinedInviteLink');
        const giftInviteInput = document.getElementById('giftInviteLink');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –º–æ–¥–∞–ª–æ–∫ (Bootstrap 5)
        let studentModalInstance = null;
        let giftModalInstance = null;
        try {
            if (studentEl) studentModalInstance = new bootstrap.Modal(studentEl);
            if (giftEl) giftModalInstance = new bootstrap.Modal(giftEl);
        } catch (err) {
            console.warn('Bootstrap Modal init failed', err);
        }

        function copyToClipboard(text) {
            if (!text) return Promise.reject(new Error('empty'));
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
            }
            return new Promise((resolve, reject) => {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    resolve();
                } catch (e) {
                    reject(e);
                }
            });
        }

        // Copy handlers
        if (joinedCopyBtn) {
            joinedCopyBtn.addEventListener('click', function () {
                const url = joinedInviteInput ? joinedInviteInput.value.trim() : '';
                if (!url) {
                    joinedCopyBtn.classList.add('btn-danger');
                    setTimeout(() => joinedCopyBtn.classList.remove('btn-danger'), 900);
                    return;
                }
                joinedCopyBtn.disabled = true;
                copyToClipboard(url).finally(() => {
                    joinedCopyBtn.disabled = false;
                });
            });
        }

        if (giftCopyBtn) {
            giftCopyBtn.addEventListener('click', function () {
                const url = giftInviteInput ? giftInviteInput.value.trim() : '';
                if (!url) {
                    giftCopyBtn.classList.add('btn-danger');
                    setTimeout(() => giftCopyBtn.classList.remove('btn-danger'), 900);
                    return;
                }
                giftCopyBtn.disabled = true;
                copyToClipboard(url).finally(() => {
                    giftCopyBtn.disabled = false;
                });
            });
        }

        // –ù–∞–∂–∞—Ç–∏–µ "–ü–æ–ª—É—á–∏—Ç—å" ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –º–æ–¥–∞–ª–∫—É –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤—Ç–æ—Ä—É—é
        if (getGiftBtn) {
            getGiftBtn.addEventListener('click', function () {
                try {
                    if (studentModalInstance) studentModalInstance.hide();
                } catch (e) {
                    // fallback: –ø–æ–ø—ã—Ç–∞–µ–º—Å—è —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ data-bs-dismiss
                    if (studentEl) studentEl.classList.remove('show');
                }

                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏, –∑–∞—Ç–µ–º –æ—Ç–∫—Ä—ã–≤–∞–µ–º gift
                setTimeout(() => {
                    try {
                        if (giftModalInstance) giftModalInstance.show();
                    } catch (e) {
                        if (giftEl) giftEl.classList.add('show');
                    }
                }, 150);
            });
        }

        // –ù–∞–∂–∞—Ç–∏–µ "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å" ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º gift –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        if (activateGiftBtn) {
            activateGiftBtn.addEventListener('click', function () {
                try {
                    if (giftModalInstance) giftModalInstance.hide();
                } catch (e) {
                    if (giftEl) giftEl.classList.remove('show');
                }

                // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x';
                alert.style.zIndex = 11000;
                alert.style.marginTop = '16px';
                alert.setAttribute('role', 'alert');
                alert.innerHTML = '–ü–æ–¥–∞—Ä–æ–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω ‚Äî –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è! <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
                document.body.appendChild(alert);

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 4 —Å–µ–∫
                setTimeout(() => {
                    try {
                        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                        bsAlert.close();
                    } catch (e) {
                        if (alert.parentNode) alert.parentNode.removeChild(alert);
                    }
                }, 4000);
            });
        }

        // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –º–æ–¥–∞–ª–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –≤–Ω–µ—à–Ω–µ, –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å studentJoinedModal —Ç–∞–∫:
        // if (studentModalInstance) studentModalInstance.show();
    });
</script>

<!-- –ú–æ–¥–∞–ª–∫–∞: –®–∞–≥ 5 ‚Äî –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (—Ñ–∏–Ω–∞–ª) -->
<div class="modal fade" id="step5Modal" tabindex="-1" aria-labelledby="step6Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="step6Label">–§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥ ‚Äî –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h5>
            </div>
            <div class="modal-body">
                <p>–†–∞—Å—Å–∫–∞–∂–∏ –Ω–∞–º, –∫–∞–∫ –ø—Ä–æ—à–ª–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
                        data-bs-toggle="modal"
                        data-bs-target="#feedbackModal">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å -->
<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm" method="post" action="{% url 'feedback' %}">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label">–ï—Å–ª–∏ –±—ã –≤–æ–ª—à–µ–±–Ω–∞—è –ø–∞–ª–æ—á–∫–∞ –º–æ–≥–ª–∞ —Ä–µ—à–∏—Ç—å –æ–¥–Ω—É –ø—Ä–æ–±–ª–µ–º—É –≤ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç–µ, —á—Ç–æ –±—ã —ç—Ç–æ –±—ã–ª–æ?</label>
                        <textarea
                            name="question_magic"
                            id="id_question_magic"
                            class="form-control"
                            rows="3"
                            placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
                        <div class="invalid-feedback" data-field="question_magic"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–ß—Ç–æ –≤—ã –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç–µ –≤ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ —É—Ä–æ–∫–∞–º?</label>
                        <textarea
                            name="question_hate"
                            id="id_question_hate"
                            class="form-control"
                            rows="3"
                            placeholder="–ß—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç –∏–ª–∏ –º–µ—à–∞–µ—Ç?"></textarea>
                        <div class="invalid-feedback" data-field="question_hate"></div>
                    </div>

                    <button type="submit"
                            class="btn btn-primary w-100"
                            onclick="updateTaskStatus('feedback', 'gift_received'); hideModal('currentModalId'); setTimeout(() => showModal('receiveGift'), 1000);">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </form>

                <!-- –ë–ª–æ–∫ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <div id="feedbackMessage" class="mt-3 text-center" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
let cookieValue = null;
if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
        }
    }
}
return cookieValue;
}

    (function () {
        const form = document.getElementById('feedbackForm');
        const msgBlock = document.getElementById('feedbackMessage');
        const modalEl = document.getElementById('feedbackModal');
        const bsModal = new bootstrap.Modal(modalEl);

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            // –°–±—Ä–æ—Å –æ—à–∏–±–æ–∫
            form.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            form.querySelectorAll('.invalid-feedback').forEach(el => {
                el.textContent = '';
            });

            const url = form.action;
            const formData = new FormData(form);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData,
            })
            .then(async (resp) => {
                if (resp.ok) {
                    return resp.json();
                } else {
                    const json = await resp.json().catch(()=> null);
                    throw {status: resp.status, json};
                }
            })
            .then(data => {
                // –£—Å–ø–µ—Ö
                msgBlock.style.display = 'block';
                msgBlock.className = 'mt-3 text-center text-success';
                msgBlock.textContent = data.message || '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å!';
                // –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                form.reset();

                // –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥—ã, –∑–∞—Ç–µ–º –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
                setTimeout(() => {
                    bsModal.hide();
                    msgBlock.style.display = 'none';
                }, 2000);
            })
            .catch(err => {
                if (err.json && err.json.errors) {
                    // –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫–∏ —Ä—è–¥–æ–º —Å –ø–æ–ª—è–º–∏
                    const errors = err.json.errors;
                    for (const [field, msgs] of Object.entries(errors)) {
                        const input = form.querySelector('[name="' + field + '"]');
                        if (input) {
                            input.classList.add('is-invalid');
                            const fb = form.querySelector('.invalid-feedback[data-field="' + field + '"]');
                            if (fb) fb.textContent = Array.isArray(msgs) ? msgs.join(' ') : msgs;
                        }
                    }
                } else {
                    // –æ–±—â–∞—è –æ—à–∏–±–∫–∞
                    msgBlock.style.display = 'block';
                    msgBlock.className = 'mt-3 text-center text-danger';
                    msgBlock.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
                }
            });
        });
    })();
</script>

<!-- ===========================
     –°–ö–†–ò–ü–¢: –ª–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
     =========================== -->
<script>
    // -------------------------
    //  –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç—É—Å–æ–≤
    // -------------------------
    let currentStatus = (function () {
        const el = document.getElementById('task-status-data');
        if (el) {
            try {
                return JSON.parse(el.textContent);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ task_status –∏–∑ —à–∞–±–ª–æ–Ω–∞', e);
            }
        }
        // fallback ‚Äî –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
        return {
            registration: "–ù–µ –ø—Ä–∏—Å—Ç—É–ø–∞–ª –∫ –∑–∞–¥–∞–Ω–∏—é",
            create_classroom: "–ù–µ –ø—Ä–∏—Å—Ç—É–ø–∞–ª –∫ –∑–∞–¥–∞–Ω–∏—é",
            task_generated: "–ù–µ –ø—Ä–∏—Å—Ç—É–ø–∞–ª –∫ –∑–∞–¥–∞–Ω–∏—é",
            section_created: "–ù–µ –ø—Ä–∏—Å—Ç—É–ø–∞–ª –∫ –∑–∞–¥–∞–Ω–∏—é",
            gift_received: "–ù–µ –ø—Ä–∏—Å—Ç—É–ø–∞–ª –∫ –∑–∞–¥–∞–Ω–∏—é",
            student_invitation: "–ù–µ –ø—Ä–∏—Å—Ç—É–ø–∞–ª –∫ –∑–∞–¥–∞–Ω–∏—é",
            student_invitation_use: "–ù–µ –ø—Ä–∏—Å—Ç—É–ø–∞–ª –∫ –∑–∞–¥–∞–Ω–∏—é",
        };
    })();

    // -------------------------
    //  –£—Ç–∏–ª–∏—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª–∫–∞–º–∏
    // -------------------------
    function showModal(modalId) {
        const el = document.getElementById(modalId);
        if (!el) {
            console.error('–ú–æ–¥–∞–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', modalId);
            return;
        }
        const inst = new bootstrap.Modal(el);
        inst.show();
    }

    function hideModal(modalId) {
        const el = document.getElementById(modalId);
        if (!el) return;
        const inst = bootstrap.Modal.getInstance(el);
        if (inst) inst.hide();
    }

    // -------------------------
    //  –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
    //  (completedTask –∏–ª–∏ nextTask –º–æ–≥—É—Ç –±—ã—Ç—å null)
    // -------------------------
    const modalFive = document.getElementById("step5Modal");
    let invitationSendLink = "";
    if (modalFive) {
        linkInput = modalFive.querySelector("#inviteLink");
        if (linkInput) {
            invitationSendLink = linkInput.value;
        }
    }
    async function updateTaskStatus(completedTask, nextTask) {
        try {
            const resp = await fetch('/users/update-task-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    completed_task: completedTask,
                    next_task: nextTask,
                    link: invitationSendLink,
                })
            });

            if (!resp.ok) {
                throw new Error('HTTP ' + resp.status);
            }

            const data = await resp.json();

            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ª–æ–∫–∞–ª—å–Ω–æ
            if (completedTask) currentStatus[completedTask] = "–í—ã–ø–æ–ª–Ω–µ–Ω–æ";
            if (nextTask && currentStatus[nextTask !== "–í—ã–ø–æ–ª–Ω–µ–Ω–æ"]) currentStatus[nextTask] = "–í –ø—Ä–æ–≥—Ä–µ—Å—Å–µ";

            return { success: true, data: data };
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ updateTaskStatus:', err);
            return { success: false, error: err };
        }
    }

    // -------------------------
    //  –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –º–æ–¥–∞–ª–∫–∏
    //  –ò–ú–Ø –§–£–ù–ö–¶–ò–ò: openRelevantModal()
    // -------------------------
    function openRelevantModal() {
        const taskOrder = [
            { key: "registration", modalId: "step1Modal" },
            { key: "create_classroom", modalId: "step2Modal" },
            { key: "task_generated", modalId: "step4Modal" },
            { key: "section_created", modalId: "step4Modal" },
            { key: "gift_received", modalId: "receiveGift" },
            { key: "student_invitation", modalId: "" },
        ];

        for (let task of taskOrder) {
            if (currentStatus[task.key] !== "–í—ã–ø–æ–ª–Ω–µ–Ω–æ") {
                showModal(task.modalId);
                return;
            }
        }
    }

    // -------------------------
    //  –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞ "–î–∞–ª—å—à–µ"
    //  currentKey / nextKey ‚Äî –∫–ª—é—á–∏ –∑–∞–¥–∞—á –≤ —á–µ–∫–ª–∏—Å—Ç–µ
    //  currentModalId / nextModalId ‚Äî id –º–æ–¥–∞–ª–æ–∫
    // -------------------------
    async function handleNext(currentKey, nextKey, currentModalId, nextModalId) {
        // –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω–æ –Ω–µ –¥–µ–ª–∞–µ–º –∑–¥–µ—Å—å
        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
        const res = await updateTaskStatus(currentKey, nextKey);
        // –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–æ–¥–∞–ª–∫–∏
        if (res.success) {
            hideModal(currentModalId);
            if (nextModalId) {
                showModal(nextModalId);
            } else {
                // –µ—Å–ª–∏ –Ω–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π –º–æ–¥–∞–ª–∫–∏ ‚Äî –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é
                openRelevantModal();
            }
        } else {
            // –ø—Ä–∏ –æ—à–∏–±–∫–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî —Å–µ–π—á–∞—Å console.error
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —à–∞–≥–∏');
        }
    }

    // -------------------------
    //  –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    // -------------------------
    let showHelpTexts = false;
    (function () {
        'use strict';

        // ---------------- –£—Ç–∏–ª–∏—Ç—ã ----------------

        // –ñ–¥—ë—Ç –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ DOM —Å –ø–æ–º–æ—â—å—é MutationObserver (Promise)
        function waitForElements(selector, timeout = 3000) {
            return new Promise((resolve, reject) => {
                const found = document.querySelectorAll(selector);
                if (found.length) return resolve(found);

                const observer = new MutationObserver((mutations, obs) => {
                    const nodes = document.querySelectorAll(selector);
                    if (nodes.length) {
                        obs.disconnect();
                        return resolve(nodes);
                    }
                });

                observer.observe(document.documentElement, { childList: true, subtree: true });

                setTimeout(() => {
                    observer.disconnect();
                    const nodes = document.querySelectorAll(selector);
                    if (nodes.length) return resolve(nodes);
                    reject(new Error('timeout waiting for ' + selector));
                }, timeout);
            });
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç taskTypes (mutate –µ—Å–ª–∏ –º–æ–∂–Ω–æ, –∏–Ω–∞—á–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ window)
        function overwriteTaskTypes(newArray) {
            try {
                if (typeof taskTypes !== 'undefined' && Array.isArray(taskTypes)) {
                    taskTypes.length = 0;
                    Array.prototype.push.apply(taskTypes, newArray);
                    return;
                }
            } catch (err) {
                // fallthrough
            }

            try {
                window.taskTypes = Array.isArray(newArray) ? newArray.slice() : [];
                console.log('overwriteTaskTypes: set window.taskTypes');
            } catch (err) {
                console.warn('overwriteTaskTypes: failed to set window.taskTypes', err);
            }
        }

        // ---------------- –ù–∞–±–æ—Ä—ã taskTypes ----------------

        const SHORT_TASK_TYPES = [
            { type: 'wordlist', title: '–°–ø–∏—Å–æ–∫ —Å–ª–æ–≤', icon: 'bi-list' },
            { type: 'test', title: '–¢–µ—Å—Ç', icon: 'bi-check-circle' },
            { type: 'fillintheblanks', title: '–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ–ø—É—Å–∫–∏', icon: 'bi-pen' },
            { type: 'makeasentence', title: '–°–æ—Å—Ç–∞–≤—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', icon: 'bi-text-paragraph' },
            { type: 'trueorfalse', title: '–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –ª–æ–∂—å', icon: 'bi-check' },
            { type: 'essay', title: '–≠—Å—Å–µ', icon: 'bi-file-earmark-text' },
            { type: 'note', title: '–ó–∞–º–µ—Ç–∫–∞', icon: 'bi-sticky' },
            { type: 'article', title: '–°—Ç–∞—Ç—å—è', icon: 'bi-newspaper' },
            { type: 'sortintocolumns', title: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º', icon: 'bi-layout-split' },
        ];

        const FULL_TASK_TYPES = [
            { type: 'wordlist', title: '–°–ø–∏—Å–æ–∫ —Å–ª–æ–≤', icon: 'bi-list' },
            { type: 'test', title: '–¢–µ—Å—Ç', icon: 'bi-check-circle' },
            { type: 'fillintheblanks', title: '–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ–ø—É—Å–∫–∏', icon: 'bi-pen' },
            { type: 'matchupthewords', title: '–°–æ–æ—Ç–Ω–µ—Å–∏ —Å–ª–æ–≤–∞', icon: 'bi-arrow-left-right' },
            { type: 'makeasentence', title: '–°–æ—Å—Ç–∞–≤—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', icon: 'bi-text-paragraph' },
            { type: 'unscramble', title: '–°–æ–±–µ—Ä–∏ —Å–ª–æ–≤–æ', icon: 'bi-puzzle' },
            { type: 'trueorfalse', title: '–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –ª–æ–∂—å', icon: 'bi-check' },
            { type: 'audio', title: '–ê—É–¥–∏–æ', icon: 'bi-volume-up' },
            { type: 'essay', title: '–≠—Å—Å–µ', icon: 'bi-file-earmark-text' },
            { type: 'note', title: '–ó–∞–º–µ—Ç–∫–∞', icon: 'bi-sticky' },
            { type: 'image', title: '–ö–∞—Ä—Ç–∏–Ω–∫–∞', icon: 'bi-image' },
            { type: 'pdf', title: 'PDF —Ñ–∞–π–ª', icon: 'bi-file-earmark-pdf' },
            { type: 'article', title: '–°—Ç–∞—Ç—å—è', icon: 'bi-newspaper' },
            { type: 'sortintocolumns', title: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º', icon: 'bi-layout-split' },
            { type: 'labelimages', title: '–ü–æ–¥–ø–∏—à–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É', icon: 'bi-tag' },
            { type: 'embeddedtask', title: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è', icon: 'bi-link-45deg' }
        ];

        // ---------------- returnTaskTypes (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑–≤–Ω–µ) ----------------
        let taskCreatedShown = false;
        window.returnTaskTypes = function returnTaskTypes() {
            console.log("called");
            overwriteTaskTypes(FULL_TASK_TYPES);
            // –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –æ–±—ã—á–Ω–æ –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º
            showHelpTexts = true;
            if (typeof updateTaskStatus === 'function') {
                try {
                    showHelpTexts = false;
                    console.log("change");
                    updateTaskStatus('task_generated', 'section_created');
                } catch (err) {
                    console.warn('returnTaskTypes: updateTaskStatus failed', err);
                }
            }
            if (typeof showModal === 'function') {
                try {
                    if (!taskCreatedShown && currentStatus['section_created'] !== "–í—ã–ø–æ–ª–Ω–µ–Ω–æ") {
                        showModal('taskCreatedModal');
                        taskCreatedShown = true;
                    }
                } catch (err) {
                    console.warn('returnTaskTypes: showModal failed', err);
                }
            }

        };

        window.completeSectionForNews = function completeSectionForNews() {
            hideModal('generationModal');
            if (currentStatus["section_created"] !== "–í—ã–ø–æ–ª–Ω–µ–Ω–æ") {
                updateTaskStatus("section_created", "gift_received");
                setTimeout(function () {
                    showModal("congratsModal");
                }, 10000);
            }
        }

        // ---------------- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ (listeners) ----------------
        document.addEventListener('DOMContentLoaded', function () {
            function byId(id) {
                return document.getElementById(id);
            }

            const guideNext = byId('guideNextBtn');
            if (guideNext) {
                guideNext.addEventListener('click', function () {
                    window.location.href = "/home";
                });
            }

            const step1Next = byId('step1NextBtn');
            if (step1Next) {
                step1Next.addEventListener('click', function () {
                    if (typeof handleNext === 'function') {
                        handleNext('registration', 'create_classroom', 'step1Modal', 'step2Modal');
                    } else {
                        console.warn('handleNext is not defined');
                    }
                });
            }

            const startClassBtn = byId('startClassBtn');
            if (startClassBtn) {
                startClassBtn.addEventListener('click', async function () {
                    try {
                        if (window.currentStatus && currentStatus['create_classroom'] !== '–í –ø—Ä–æ–≥—Ä–µ—Å—Å–µ') {
                            if (typeof updateTaskStatus === 'function') {
                                await updateTaskStatus('registration', 'create_classroom');
                            }
                        }
                    } catch (err) {
                        console.warn('startClassBtn click: updateTaskStatus error', err);
                    }
                    if (typeof hideModal === 'function') hideModal('step2Modal');
                    if (typeof showModal === 'function') showModal('createClassroomModal');
                });
            }

            const createCourseBtn = byId('createCourseBtn');
            if (createCourseBtn) {
                createCourseBtn.addEventListener('click', async function () {
                    try {
                        if (window.currentStatus) {
                            if (typeof updateTaskStatus === 'function') {
                                await updateTaskStatus('create_classroom', 'task_generated');
                            }
                        }
                    } catch (err) {
                        console.warn('createCourseBtn click: updateTaskStatus error', err);
                    }
                    if (typeof hideModal === 'function') hideModal('step4Modal');
                    if (typeof showModal === 'function') showModal('addCourseModal');
                });
            }

            // –õ–æ–≥–∏–∫–∞ —Ä–µ–∂–∏–º–æ–≤
            const infoStatusContainer = byId('infoStatusContainer');
            if (infoStatusContainer) {
                const statusMode = infoStatusContainer.dataset.mode;
                if (!window.currentStatus) window.currentStatus = {};

                if (statusMode === 'generation') {
                    if (currentStatus['task_generated'] !== '–í—ã–ø–æ–ª–Ω–µ–Ω–æ') {
                        window.showHelpTexts = true;
                        showModal("addTaskGuideModal");

                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–∫–æ—Ä–æ—á–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä taskTypes
                        overwriteTaskTypes(SHORT_TASK_TYPES);

                    } else if (currentStatus['section_created'] !== '–í—ã–ø–æ–ª–Ω–µ–Ω–æ') {
                        if (typeof showModal === 'function') showModal('taskCreatedModal');
                    }
                }
            }
        });
    })();
</script>





<!-- –ß–µ–∫ –ª–∏—Å—Ç -->
<!-- –ò–∫–æ–Ω–∫–∞ —á–µ–∫-–ª–∏—Å—Ç–∞ -->
<button id="checklistBtn" class="btn btn-light rounded-circle position-fixed shadow d-none"
        style="bottom:20px; width:50px; height:50px; z-index:1050;"
        aria-expanded="false" aria-controls="checklistPanel" title="–ß–µ–∫-–ª–∏—Å—Ç">
    <i class="bi bi-card-checklist fs-4" aria-hidden="true"></i>
    <span class="visually-hidden">–û—Ç–∫—Ä—ã—Ç—å —á–µ–∫-–ª–∏—Å—Ç</span>
</button>

<!-- –ü–∞–Ω–µ–ª—å —á–µ–∫-–ª–∏—Å—Ç–∞ -->
<div id="checklistPanel" class="card shadow position-fixed"
     style="bottom:80px; max-width:360px; width:90vw; display: none; z-index:10500;"
     role="region" aria-label="–ß–µ–∫-–ª–∏—Å—Ç –∑–∞–¥–∞–Ω–∏–π">
    <div class="card-header d-flex justify-content-between align-items-center bg-white">
        <span class="fw-bold">–ß–µ–∫-–ª–∏—Å—Ç</span>
        <button type="button" class="btn-close btn-close-black btn-sm" aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–µ–∫-–ª–∏—Å—Ç"></button>
    </div>

    <div class="card-body p-2">
        <ul id="checklistItems" class="list-unstyled mb-0">
            <!-- 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
            <li class="d-flex align-items-start mb-3 checklist-item" data-step="registration">
                <div class="me-2">
                    <span class="status-dot d-inline-flex rounded-circle align-items-center justify-content-center"
                          style="width:20px; height:20px; font-size:0.75rem;"></span>
                </div>
                <div>
                    <div class="fw-bold"><a href="{% url 'home' %}" class="text-decoration-none">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
                    <div class="small text-muted checklist-desc">–ù–∞—á–Ω–∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π</div>
                </div>
            </li>

            <!-- 2. –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å -->
            <li class="d-flex align-items-start mb-3 checklist-item" data-step="create_classroom">
                <div class="me-2">
                    <span class="status-dot d-inline-flex rounded-circle align-items-center justify-content-center"
                          style="width:20px; height:20px; font-size:0.75rem;"></span>
                </div>
                <div>
                    <div class="fw-bold">
                        <a href="{% url 'home' %}" class="text-decoration-none">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∫–ª–∞—Å—Å</a>
                    </div>
                    <div class="small text-muted checklist-desc">–î–æ–±–∞–≤—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤</div>
                </div>
            </li>

            <!-- 4. –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —É—Ä–æ–∫ -->
            <li class="d-flex align-items-start mb-3 checklist-item" data-step="unique_lesson">
                <div class="me-2">
                    <span class="status-dot d-inline-flex rounded-circle align-items-center justify-content-center"
                          style="width:20px; height:20px; font-size:0.75rem;"></span>
                </div>
                <div>
                    <div class="fw-bold">
                        <a href="{% url 'home' %}" class="text-decoration-none">–°–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —É—Ä–æ–∫</a>
                    </div>
                    <div class="small text-muted checklist-desc">–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∑–∞–¥–∞–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –≥–æ—Ç–æ–≤—ã–π</div>
                </div>
            </li>

            <!-- 6. –í—Å–µ –≥–æ—Ç–æ–≤–æ ‚Äî –ø—Ä–∏–≥–ª–∞—à–∞–π –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <li class="align-items-start mb-3 checklist-item" data-step="invite_ready" id="student_invitation_point" style="display: none;">
                <div class="me-2">
                    <span class="status-dot d-inline-flex rounded-circle align-items-center justify-content-center"
                          style="width:20px; height:20px; font-size:0.75rem;"></span>
                </div>
                <div>
                    <div class="text-start">
                        <button onclick="showModal('studentInviteModal'); document.getElementById('checklistPanel').style.display = 'none';"
                                class="btn border-0 p-0 m-0 text-primary text-start fw-bold text-decoration-none">
                            –í—Å–µ –≥–æ—Ç–æ–≤–æ ‚Äî –ø—Ä–∏–≥–ª–∞—à–∞–π –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ üéâ
                        </button>
                    </div>
                    <div class="small text-muted checklist-desc">–¢–µ–ø–µ—Ä—å —Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
                </div>
            </li>
        </ul>
    </div>

    <div class="card-footer d-flex flex-column gap-2">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">–ü—Ä–æ–≥—Ä–µ—Å—Å</small>
            <small id="checklistPercent" class="fw-bold">0% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
        </div>
        <div class="progress" style="height:8px;">
            <div id="checklistProgressBar" class="progress-bar" role="progressbar" style="width:0%;" aria-valuemin="0"
                 aria-valuemax="100"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // --- –≠–ª–µ–º–µ–Ω—Ç—ã –ø–∞–Ω–µ–ª–∏ ---
        const checklistToggleBtn = document.getElementById("checklistBtn");
        const checklistPanelEl = document.getElementById("checklistPanel");
        const checklistCloseBtn = checklistPanelEl ? checklistPanelEl.querySelector(".btn-close") : null;
        const checklistItemsContainer = document.getElementById("checklistItems");
        const checklistPercentEl = document.getElementById("checklistPercent");
        const checklistProgressBarEl = document.getElementById("checklistProgressBar");
        if (infoStatusContainer) {
            const statusMode = infoStatusContainer.dataset.mode;
            if (statusMode === 'home') {
                checklistToggleBtn.classList.remove('d-none');
                checklistToggleBtn.style.right = "20px";
                checklistPanelEl.style.right = "20px";
            } else {
                checklistToggleBtn.classList.remove('d-none');
                checklistToggleBtn.style.left = "20px";
                checklistPanelEl.style.left = "20px";
            }
        }

        // safety: –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if (!checklistToggleBtn || !checklistPanelEl || !checklistItemsContainer) {
            console.warn("Checklist: –Ω–µ –≤—Å–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, —á–µ–∫-–ª–∏—Å—Ç –æ—Ç–∫–ª—é—á—ë–Ω.");
            return;
        }

        // --- Toggle –ø–∞–Ω–µ–ª–∏: –Ω–∞–¥–µ–∂–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ ---
        const openChecklistPanel = () => {
            checklistPanelEl.style.display = "block";
            checklistToggleBtn.setAttribute("aria-expanded", "true");
            // —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            checklistPanelEl.setAttribute("tabindex", "-1");
            checklistPanelEl.focus();
        };
        const closeChecklistPanel = () => {
            checklistPanelEl.style.display = "none";
            checklistToggleBtn.setAttribute("aria-expanded", "false");
            // –≤–µ—Ä–Ω—É—Ç—å —Ñ–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫—É
            checklistToggleBtn.focus();
        };
        const toggleChecklistPanel = (e) => {
            if (e && e.stopPropagation) e.stopPropagation();
            checklistPanelEl.style.display === "block" ? closeChecklistPanel() : openChecklistPanel();
        };

        // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º "–º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–æ–µ" –∑–∞–∫—Ä—ã—Ç–∏–µ: –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö
        checklistToggleBtn.addEventListener("click", toggleChecklistPanel);
        checklistToggleBtn.addEventListener("click", (e) => e.stopPropagation());
        if (checklistCloseBtn) {
            checklistCloseBtn.addEventListener("click", function (e) {
                e.stopPropagation();
                closeChecklistPanel();
            });
        }
        // –∫–ª–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç –µ—ë
        checklistPanelEl.addEventListener("click", (e) => e.stopPropagation());
        // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–∞–Ω–µ–ª–∏
        document.addEventListener("click", (e) => {
            if (checklistPanelEl.style.display === "block" && !checklistPanelEl.contains(e.target) && !checklistToggleBtn.contains(e.target)) {
                closeChecklistPanel();
            }
        });
        // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ Escape
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && checklistPanelEl.style.display === "block") {
                closeChecklistPanel();
            }
        });

        // --- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ 'completed'|'in_progress'|'not_started' ---
        function normalizeChecklistStatus(val) {
            if (val === null || typeof val === "undefined") return "not_started";
            const s = String(val).toLowerCase().trim();

            // completed hints
            if (s.includes("–≤—ã–ø–æ–ª–Ω") || s.includes("–∑–∞–≤–µ—Ä—à") || s.includes("completed") || s.includes("done") || s === "true") {
                return "completed";
            }
            // in progress hints
            if (s.includes("–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ") || s.includes("in_progress") || s.includes("in progress") || s.includes("progress") || s.includes("pending")) {
                return "in_progress";
            }
            // boolean-like positive
            if (s === "yes" || s === "1") return "completed";

            // not started hints
            if (s.includes("–Ω–µ –ø—Ä–∏—Å—Ç—É–ø–∞–ª") || s.includes("not started") || s.includes("not_started") || s.includes("false")) {
                return "not_started";
            }

            // –ö–æ—Ä–æ—Ç–∫–∞—è —Å—Ç—Ä–æ–∫–∞ —Å —Ü–∏—Ñ—Ä–æ–π ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å—Å/–¥–∞—Ç–∞/–∏–¥ => in_progress (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ)
            if (s.length > 0 && s.length < 30 && /\d/.test(s)) {
                return "in_progress";
            }

            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî not_started
            return "not_started";
        }

        let statusSource = currentStatus;

        // --- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —à–∞–≥–æ–≤ ---
        function computeUniqueLessonStepStatus(statusSource) {
            const taskGen = normalizeChecklistStatus(statusSource.task_generated);
            const sectionGen = normalizeChecklistStatus(statusSource.section_created);

            if (taskGen === "completed" && sectionGen === "completed") return "completed";
            if (taskGen === "in_progress" || sectionGen === "in_progress" || taskGen === "completed" || sectionGen === "completed") return "in_progress";
            return "not_started";
        }

        function computeInviteStudentStepStatus(statusSource) {
            const inv = normalizeChecklistStatus(statusSource.student_invitation);
            const invUse = normalizeChecklistStatus(statusSource.student_invitation_use);
            const gift = normalizeChecklistStatus(statusSource.gift_received);

            if (gift === "completed") return "completed";
            if (inv === "in_progress" || invUse === "in_progress" || inv === "completed" || invUse === "completed") return "in_progress";
            return "not_started";
        }

        // --- –£—Ç–∏–ª–∏—Ç–∞: –∑–∞–º–µ–Ω–∏—Ç—å node <a> –Ω–∞ plain text (span), —Å–æ—Ö—Ä–∞–Ω—è—è aria attrs ---
        function replaceInteractiveWithText(el) {
            if (!el) return;

            const text = el.textContent.trim();
            const span = document.createElement("span");
            span.textContent = text;
            span.classList.remove("text-primary");

            // —Å–æ—Ö—Ä–∞–Ω—è–µ–º aria-label, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (el.getAttribute("aria-label")) {
                span.setAttribute("aria-label", el.getAttribute("aria-label"));
            }

            el.replaceWith(span);
        }

        // --- –£—Ç–∏–ª–∏—Ç–∞: –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∞ (—Å–æ–∑–¥–∞—Ç—å <a> —Ç–æ–ª—å–∫–æ –¥–ª—è in_progress) ---
        function ensureClickableTitleForInProgress(liEl, stepKey) {
            const titleContainer = liEl.querySelector(".fw-bold");
            if (!titleContainer) return;

            const existingAnchor = titleContainer.querySelector("a");
            if (existingAnchor) {
                // –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –µ—Å—Ç—å, –¥–µ–ª–∞–µ–º –µ—ë –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π (–æ—Å—Ç–∞–≤–ª—è–µ–º href –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
                existingAnchor.setAttribute("role", "link");
                existingAnchor.style.cursor = "pointer";
                // –µ—Å–ª–∏ —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ (–µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –≤–µ–¥—ë—Ç –≤ '#', –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–º –¥–µ—Ñ–æ–ª—Ç)
                existingAnchor.addEventListener("click", function (e) {
                    if (this.getAttribute("href") === "#" || this.getAttribute("href") === "" || this.dataset.action) {
                        e.preventDefault();
                        document.dispatchEvent(new CustomEvent("checklist:action", { detail: { step: stepKey } }));
                    }
                }, { once: true });
                return;
            }

            // –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º "—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é" —Å—Å—ã–ª–∫—É, –∫–æ—Ç–æ—Ä–∞—è —ç–º–∏—Ç–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ
            const text = titleContainer.textContent.trim();
            const a = document.createElement("a");
            a.href = "#";
            a.className = "text-decoration-none";
            a.textContent = text;
            a.setAttribute("role", "link");
            a.addEventListener("click", function (e) {
                e.preventDefault();
                document.dispatchEvent(new CustomEvent("checklist:action", { detail: { step: stepKey } }));
            });

            titleContainer.textContent = "";
            titleContainer.appendChild(a);
        }

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —á–µ–∫-–ª–∏—Å—Ç–∞ –ø–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É —Å—Ç–∞—Ç—É—Å–æ–≤ ---
        function renderChecklistFromStatus(statusSource) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–π –≤ —Ñ–∞–π–ª–µ currentStatus (–æ–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ –æ–Ω –µ—Å—Ç—å)
            const source = (statusSource && typeof statusSource === "object") ? statusSource : (currentStatus || {});

            const checklistItemEls = Array.from(document.querySelectorAll("#checklistItems .checklist-item"));
            const rawStatusMap = {
                registration: normalizeChecklistStatus(source.registration),
                create_classroom: normalizeChecklistStatus(source.create_classroom),
                unique_lesson: computeUniqueLessonStepStatus(source),
            };

            // ‚ö°Ô∏è –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º "in_progress" –≤ "not_started", —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å —Ü–∏–∫–ª—É
            const statusMap = {};
            Object.keys(rawStatusMap).forEach(key => {
                statusMap[key] = rawStatusMap[key] === "in_progress" ? "not_started" : rawStatusMap[key];
            });

            let completedStepsCount = 0;
            let inProgressAssigned = false;

            checklistItemEls.forEach((li) => {
                const stepKey = li.getAttribute("data-step");
                const statusDotEl = li.querySelector(".status-dot");
                const descriptionEl = li.querySelector(".checklist-desc");
                const titleContainer = li.querySelector(".fw-bold");
                let stepStatus = statusMap[stepKey] || "not_started";

                // ‚úÖ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —à–∞–≥ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
                if (stepStatus === "not_started" && !inProgressAssigned) {
                    stepStatus = "in_progress";
                    inProgressAssigned = true;
                } else if (stepStatus === "not_started" && inProgressAssigned) {
                    stepStatus = "not_started"; // —è–≤–Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º
                }

                // --- –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ---
                statusDotEl.className = "status-dot d-inline-flex rounded-circle align-items-center justify-content-center";

                if (stepStatus === "completed") {
                    statusDotEl.classList.add("bg-success", "text-white");
                    statusDotEl.textContent = "‚úì";
                    if (descriptionEl) descriptionEl.textContent = "–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ";
                    completedStepsCount++;
                    li.classList.remove("opacity-75");
                    li.style.display = "flex";

                    if (titleContainer) {
                        const anchor = titleContainer.querySelector("a");
                        const button = titleContainer.querySelector("button");

                        if (anchor) {
                            replaceInteractiveWithText(anchor);
                        } else if (button) {
                            replaceInteractiveWithText(button);
                        } else {
                            titleContainer.textContent = titleContainer.textContent.trim();
                        }
                    }
                } else if (stepStatus === "in_progress") {
                    statusDotEl.classList.add("bg-warning", "mt-1");
                    statusDotEl.innerHTML = "";
                    if (descriptionEl) descriptionEl.textContent = "–í –ø—Ä–æ—Ü–µ—Å—Å–µ ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å –Ω–µ–º–Ω–æ–≥–æ";
                    li.classList.remove("opacity-75");
                    li.style.display = "flex";

                    if (titleContainer) ensureClickableTitleForInProgress(li, stepKey);
                } else { // not_started
                    statusDotEl.classList.add("bg-light", "border", "mt-1");
                    statusDotEl.innerHTML = "";
                    if (descriptionEl) {
                        const hints = {
                            registration: "–ó–∞–≤–µ–¥–∏ –∞–∫–∫–∞—É–Ω—Ç –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ e-mail",
                            create_classroom: "–î–æ–±–∞–≤—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤",
                            profile_fill: "–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è",
                            unique_lesson: "–ù–∞—É—á–∏—Å—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫–∏ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ",
                            feedback: "–†–∞—Å—Å–∫–∞–∂–∏ –∫–∞–∫ –ø—Ä–æ—à–ª–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π"
                        };
                        descriptionEl.textContent = hints[stepKey] || "–ù–µ –Ω–∞—á–∞—Ç–æ";
                    }
                    li.classList.add("opacity-75");

                    if (titleContainer) {
                        const anchor = titleContainer.querySelector("a");
                        const button = titleContainer.querySelector("button");

                        if (anchor) {
                            replaceInteractiveWithText(anchor);
                        } else if (button) {
                            replaceInteractiveWithText(button);
                        }
                    }
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const completionPercent = Math.round((completedStepsCount / 3) * 100);
            if (checklistPercentEl) checklistPercentEl.textContent = `${completionPercent}% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`;
            if (checklistProgressBarEl) {
                checklistProgressBarEl.style.width = `${completionPercent}%`;
                checklistProgressBarEl.classList.remove("bg-success", "bg-info", "bg-warning", "bg-secondary");
                if (completionPercent >= 80) checklistProgressBarEl.classList.add("bg-success");
                else if (completionPercent >= 50) checklistProgressBarEl.classList.add("bg-primary");
                else if (completionPercent > 0) checklistProgressBarEl.classList.add("bg-warning");
                else checklistProgressBarEl.classList.add("bg-secondary");
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ title –∫–Ω–æ–ø–∫–∏
            checklistToggleBtn.setAttribute("title", `–ß–µ–∫-–ª–∏—Å—Ç ‚Äî ${completionPercent}% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`);
        }

        // --- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –æ–±–Ω–æ–≤–ª—è–µ—Ç —á–µ–∫-–ª–∏—Å—Ç ---
        // –ú–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å: window.updateChecklist() –∏–ª–∏ window.updateChecklist(newStatusObject)
        window.updateChecklist = function (newStatus) {
            if (newStatus && typeof newStatus === "object") {
                try {
                    window.currentStatus = newStatus;
                } catch (err) {
                    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤ window.currentStatus:", err);
                }
            }
            renderChecklistFromStatus(currentStatus || {});
        };

        // Initial render
        window.updateChecklist();
    });
</script>