{% load static %}
{% load custom_tags %}
<!doctype html>
<html lang="ru">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>LinguaGlow - onboarding</title>
        {% load custom_filters %}
        {% load custom_users_tags %}
        {% load static %}
        <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

        <!-- Bootstrap 5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

        <style>
            :root {
                --card-radius: 22px;
                --card-shadow: 0 10px 30px rgba(0, 0, 0, .12);
            }

            .modal-dialog {
                max-width: 640px;
            }

            .modal-dialog-centered {
                min-height: calc(100% - 1rem);
            }

            .modal-content {
                border-radius: var(--card-radius);
                box-shadow: var(--card-shadow);
                border: 0;
            }

            .modal.fade .modal-dialog {
                transition: transform .38s ease, opacity .38s ease;
                transform: translateY(16px) scale(.98);
                opacity: .0;
            }

            .modal.show .modal-dialog {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            .topic-chip {
                border-radius: 999px;
                padding: .5rem .9rem;
                border: 1px solid rgba(0, 0, 0, .08);
                transition: transform .15s ease, background-color .2s ease;
            }

            .topic-chip:hover {
                transform: translateY(-1px);
            }

            .subtle {
                color: #6c757d;
                font-size: .95rem;
            }

            .ghost-btn {
                opacity: .8
            }

            .progress {
                height: 10px;
            }

            .guide-step {
                border-radius: 16px;
                border: 1px solid rgba(0, 0, 0, .06);
                padding: .9rem 1rem;
                background: #fff;
            }

            .swap-enter {
                animation: swapIn .35s ease both;
            }

            @keyframes swapIn {
                from {
                    opacity: 0;
                    transform: translateY(8px)
                }

                to {
                    opacity: 1;
                    transform: none
                }
            }
        </style>
    </head>
    <body class="bg-light">

        <!-- Yandex.Metrika counter -->
        <script type="text/javascript">
            (function(m,e,t,r,i,k,a){
                m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
                m[i].l=1*new Date();
                for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
                k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
            })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=103833195', 'ym');

            ym(103833195, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
        </script>

        <!-- 1) –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
        <div class="modal fade" id="greetingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body p-4 text-center">
                        <div class="mb-2 fs-5">–ü—Ä–∏–≤–µ—Ç üëã</div>
                        <h4 class="mb-3">–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –≥–æ—Ç–æ–≤–∏—Ç—å —É—Ä–æ–∫–∏ –≤ 10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ.</h4>
                        <p class="subtle mb-4">–î–∞–≤–∞–π –Ω–∞—á–Ω—ë–º?</p>
                        <button id="createLessonBtn" class="btn btn-primary btn-lg px-4" data-bs-toggle="modal" data-bs-target="#segmentationModal">
                            –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2) –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è + —Ç–µ–º–∞ -->
        <div class="modal fade" id="segmentationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title">–ö—Ç–æ —Ç—ã?</h5>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex gap-2 flex-wrap mb-3">
                            <button class="btn btn-outline-success option-btn" data-role="–û–Ω–ª–∞–π–Ω-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä">–û–Ω–ª–∞–π–Ω-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä</button>
                            <button class="btn btn-outline-success option-btn" data-role="–û—Ñ—Ñ–ª–∞–π–Ω-–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å">–û—Ñ—Ñ–ª–∞–π–Ω-–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</button>
                            <button class="btn btn-outline-success option-btn" data-role="–®–∫–æ–ª—å–Ω—ã–π —É—á–∏—Ç–µ–ª—å">–®–∫–æ–ª—å–Ω—ã–π —É—á–∏—Ç–µ–ª—å</button>
                        </div>

                        <hr class="my-3">

                        <div class="mb-2 fw-semibold">–í—ã–±–µ—Ä–∏ —Ç–µ–º—É</div>
                        <div class="d-flex gap-2 flex-wrap mb-3">
                            <button class="btn topic-chip" data-topic="Animals">Animals</button>
                            <button class="btn topic-chip" data-topic="Back_to_school">Back to school</button>
                            <button class="btn topic-chip" data-topic="Online_shopping">Online shopping</button>
                            <button class="btn topic-chip" data-topic="AI">AI</button>
                        </div>

                        {% generate_lesson %}
                        <button id="randomTopic" class="btn btn-link text-decoration-none px-0">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Ç–µ–º—É üé≤</button>

                        <div class="mt-3 subtle">–í—ã–±—Ä–∞–Ω–æ: <span id="pickedRole" class="fw-semibold">‚Äî</span> ‚Ä¢ <span id="pickedTopic" class="fw-semibold">‚Äî</span></div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button class="toGenerationBtn btn btn-primary" disabled data-bs-toggle="modal" data-bs-target="#generationModal">
                            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è -->
        <div class="modal fade" id="generationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body p-4">
                        <h5 class="mb-2">–ò–ò –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –≤–∞—à —É—Ä–æ–∫</h5>
                        <p class="subtle">–≠—Ç–æ –∑–∞–π–º—ë—Ç –¥–æ 2 –º–∏–Ω—É—Ç.</p>
                        <div class="progress mb-2">
                            <div id="genProgressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between subtle mb-3">
                            <span>–ì–æ—Ç–æ–≤–æ:</span>
                            <span id="genPercent">0%</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="toResultBtn" class="btn btn-primary ms-auto" disabled data-bs-toggle="modal" data-bs-target="#resultModal">
                                –î–∞–ª—å—à–µ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4) –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body p-4">
                        <div class="d-flex align-items-center mb-2">
                            <span class="fs-5 me-2">‚ú®</span>
                            <h5 class="m-0">–ì–æ—Ç–æ–≤—ã–π —É—Ä–æ–∫</h5>
                        </div>
                        <p class="mb-4"><span id="topicInResult">{topic}</span></p>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button id="seeInClassBtn" class="btn btn-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –∫–ª–∞—Å—Å–µ</button>
                        </div>
                        <div class="subtle">–í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å—ç–∫–æ–Ω–æ–º–∏–ª–∏ 45 –º–∏–Ω—É—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ üéâ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback -->
        <div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content shadow-lg border-0 rounded-4">
                    <div class="modal-body p-4 text-center">
                        <!-- –ò–∫–æ–Ω–∫–∞ —Å–≤–µ—Ä—Ö—É -->
                        <div class="mb-3">
                            <span class="fs-1">üéâ</span>
                        </div>

                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                        {% if is_paid %}
                            <h5 class="fw-bold mb-3 text-success">
                                –í–∞—à –ø–æ–¥–∞—Ä–æ–∫ ‚Äî <span class="text-primary">500 —Ç–æ–∫–µ–Ω–æ–≤</span> üéÅ<br>
                                + <span class="text-warning">–ü—Ä–µ–º–∏—É–º!</span>
                            </h5>
                        {% else %}
                            <h5 class="fw-bold mb-3 text-primary">
                                üéÅ –í–∞—à –ø–æ–¥–∞—Ä–æ–∫ ‚Äî <span class="text-warning">7 –¥–Ω–µ–π –ü—Ä–µ–º–∏—É–º–∞!</span>
                            </h5>
                        {% endif %}

                        <!-- –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
                        <p class="text-muted mb-4">–ó–∞–±–µ—Ä–∏ –µ–≥–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:</p>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="d-flex flex-column gap-3">
                            {% if lesson_id %}
                                <a href="{% url 'download_pdf' lesson_id %}" target="_blank"
                                   class="btn btn-success btn-lg d-flex align-items-center justify-content-center gap-2 rounded-pill fs-6 fs-md-5">
                                   <i class="bi bi-download fs-5"></i> –°–∫–∞—á–∞—Ç—å —É—Ä–æ–∫ –≤ PDF
                                </a>
                            {% endif %}
                            <a href="{% url 'invitation_guide' %}" target="_blank"
                               class="btn btn-primary btn-lg d-flex align-items-center justify-content-center gap-2 rounded-pill fs-6 fs-md-5"
                               onclick="updateStep('done')">
                               <i class="bi bi-telegram fs-5"></i> –ì–∞–π–¥: –ö–∞–∫ –≤–µ—Å—Ç–∏ –∑–∞–Ω—è—Ç–∏—è –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –∫–ª–∞—Å—Å–µ
                            </a>

                            <a href="{% url 'home' %}"
                               class="btn btn-outline-secondary btn-lg d-flex align-items-center justify-content-center gap-2 rounded-pill fs-6 fs-md-5"
                               onclick="updateStep('done')">
                               <i class="bi bi-house fs-5"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="recreateModal" tabindex="-1" aria-hidden="true"
             data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <!-- Header -->
                    <div class="modal-header">
                        <h5 class="modal-title">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–±–æ–ª—å—à–∞—è –æ—à–∏–±–∫–∞.</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Body -->
                    <div class="modal-body">
                        <p class="mb-0">–ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫ —Å–Ω–æ–≤–∞?</p>
                    </div>

                    <!-- Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-success" onclick="updateStep('done'); window.location.reload();">
                            –ù–µ—Ç, –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        </button>
                        <button type="button" class="btn btn-success" onclick="updateStep('segment'); window.location.reload();">
                            –î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap 5 JS + Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
            let picked = { role: null, topic: null };

            // helper –¥–ª—è API (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–º—è –ø—É—Ç–∏ –∏–∑ urls.py)
            const UPDATE_URL = "{% url 'onboarding_update' %}";

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                    const cookies = document.cookie.split(";");
                    for (let c of cookies) {
                        c = c.trim();
                        if (c.startsWith(name + "=")) {
                            cookieValue = decodeURIComponent(c.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function updateStep(step, extra = {}) {
                const payload = Object.assign({ step }, extra);
                return fetch(UPDATE_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    credentials: "same-origin",
                    body: JSON.stringify(payload)
                }).then(res => {
                    if (!res.ok) console.warn('onboarding update failed', res.status);
                    return res.json().catch(() => {});
                }).catch(err => console.error("Onboarding update error:", err));
            }

            // 1) Greeting -> Segmentation
            document.getElementById("createLessonBtn").addEventListener("click", () => {
                updateStep("segment");
            });

            // –†–æ–ª—å
            document.querySelectorAll("#segmentationModal .option-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll("#segmentationModal .option-btn")
                        .forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    picked.role = btn.dataset.role || btn.textContent.trim();
                    document.getElementById("pickedRole").textContent = picked.role;
                    updateContinueState();
                });
            });

            // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã
            document.querySelectorAll("#segmentationModal .topic-chip").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.getElementById("pickedTopic").textContent = btn.textContent.trim();
                    document.getElementById("lessonGenerationTopic").value = btn.textContent.trim();
                    document.querySelectorAll('.toGenerationBtn').forEach(btn => {
                        btn.dataset.topic = btn.textContent.trim();
                    });
                    updateContinueState();
                });
            });

            // –í–≤–æ–¥ –≤—Ä—É—á–Ω—É—é
            document.getElementById("lessonGenerationTopic").addEventListener("input", (e) => {
                const topic = e.target.value.trim();
                document.getElementById("pickedTopic").textContent = topic;
                document.querySelectorAll('.toGenerationBtn').forEach(btn => {
                    btn.dataset.topic = topic;
                });
                updateContinueState();
            });

            // –†–∞–Ω–¥–æ–º–Ω–∞—è —Ç–µ–º–∞
            document.getElementById("randomTopic").addEventListener("click", () => {
                const pool = ["Food", "Travel", "Jobs", "Hobbies", "Technologies", "Music", "Sports", "Cinema", "Nature"];
                const t = pool[Math.floor(Math.random() * pool.length)];
                document.getElementById("pickedTopic").textContent = t;
                document.getElementById("lessonGenerationTopic").value = t;
                document.querySelectorAll('.toGenerationBtn').forEach(btn => {
                    btn.dataset.topic = picked.topic;
                });
                updateContinueState();
            });

            function updateContinueState() {
                const toGen = document.querySelectorAll('.toGenerationBtn');
                document.querySelectorAll('.toGenerationBtn').forEach(btn => {
                    btn.disabled = !(picked.role && document.getElementById("lessonGenerationTopic").value);
                });
            }

            // 2) –ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            document.querySelectorAll(".toGenerationBtn").forEach(button => {
                button.addEventListener("click", async (e) => {
                    const btn = e.currentTarget;
                    const topicInput = document.getElementById("lessonGenerationTopic");
                    picked.topic = topicInput ? topicInput.value : "";  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ input –¥–ª—è —Ç–µ–º—ã

                    // 1. –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–ø–∏–Ω–Ω–µ—Ä–æ–º
                    btn.disabled = true;
                    const oldHtml = btn.innerHTML;
                    btn.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        –ü–æ–¥–æ–∂–¥–∏—Ç–µ...
                    `;

                    try {
                        // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                        const result = await generateLessonRequest();
                        console.log(picked);

                        if (result?.generation_id) {
                            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∞–≥ + generation_id
                            console.log(picked);
                            await updateStep("generation_waiting", {
                                topic: picked.topic,
                                role: picked.role,
                                generation_id: result.generation_id
                            });

                            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞
                            pollGenerationStatus(result.generation_id);
                        } else {
                            alert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.");
                        }
                    } catch (err) {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏", err);
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏!");
                    } finally {
                        // 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        btn.disabled = false;
                        btn.innerHTML = oldHtml;
                    }
                });
            });

            function updateLessonGenerationStatus(percent) {
                const bar = document.getElementById("genProgressBar");
                const txt = document.getElementById("genPercent");
                const toResult = document.getElementById("toResultBtn");

                const clamped = Math.min(100, Math.max(0, Math.round(percent)));

                bar.style.width = clamped + "%";
                bar.setAttribute("aria-valuenow", String(clamped));
                txt.textContent = clamped + "%";

                // –µ—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ 100% ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
                if (clamped >= 100) {
                    toResult.disabled = false;
                }
            }

            // –ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            document.getElementById("toResultBtn").addEventListener("click", () => {
                const topic = picked.topic ? "–£—Ä–æ–∫ –Ω–∞ —Ç–µ–º—É ¬´" + picked.topic + "¬ª –≥–æ—Ç–æ–≤." : "–í–∞—à –ø–ª–∞–Ω —É—Ä–æ–∫–∞ –≥–æ—Ç–æ–≤.";
                document.getElementById("topicInResult").textContent = topic;

                updateStep("generation_result", { topic: picked.topic })
                    .then(data => {
                        if (data && data.lesson_url && data.pdf_url) {
                            document.getElementById("seeInClassBtn").onclick = () => {
                                window.location.href = data.lesson_url;
                            };
                        }
                    });
            });


            // Result -> Feedback
            document.getElementById("seeInClassBtn").addEventListener("click", () => {
                updateStep("generation_feedback");
            });

            document.addEventListener("DOMContentLoaded", async () => {
                const state = window.ONBOARDING || {};
                let { current_step, generation_id, lesson_id } = state;

                const order = ["hello", "segment", "generation_waiting", "generation_result", "generation_feedback", "incorrect"];
                function stepIndex(step) {
                    return order.indexOf(step);
                }
                if (stepIndex(current_step) > stepIndex("segment") && !generation_id) {
                    current_step = "segment";
                    await updateStep("segment");
                }

                function showModal(id) {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const m = new bootstrap.Modal(el, { backdrop: "static", keyboard: false });
                    m.show();
                }

                switch (current_step) {
                    case "hello":
                        showModal("greetingModal");
                        break;
                    case "segment":
                        showModal("segmentationModal");
                        break;
                    case "generation_waiting":
                        showModal("generationModal");
                        if (generation_id) {
                            pollGenerationStatus(generation_id);
                        }
                        break;
                    case "generation_result":
                        showModal("generationModal");
                        if (generation_id) {
                            pollGenerationStatus(generation_id);
                        }
                        break;
                    case "generation_feedback":
                        showModal("feedbackModal");
                        break;
                    case "incorrect":
                        showModal("segmentationModal");
                        break;
                    default:
                        showModal("greetingModal");
                }
            });

            window.ONBOARDING = {{ onboarding_json|safe }};
        </script>

    </body>
</html>
